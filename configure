#!/bin/sh
# set -u
function error () { printf >&2 "%s\n\nPlease see README.md for build instructions.\n" "$1"; exit 1; }

function header_exists ()
{
	local header="$1"
	while IFS= read -r dir; do
		[[ -z "$dir" ]] && continue
		if [[ -f "${dir}/${header}" ]]; then
			return 0
		fi
	done <<EOF
$(printf "%s" "$INCLUDE_PATHS" | tr ':' '\n')
EOF
	return 1
}

function library_exists ()
{
	local library="$1"
	while IFS= read -r dir; do
		[[ -z "$dir" ]] && continue
		for candidate in "${dir}/lib${library}."*; do
			if [[ -f "$candidate" ]]; then
				return 0
			fi
		done
	done <<EOF
$(printf "%s" "$LIB_PATHS" | tr ':' '\n')
EOF
	return 1
}

BREW_PREFIX=""
if command -v brew >/dev/null 2>&1; then
	BREW_PREFIX="$(brew --prefix 2>/dev/null || true)"
fi

INCLUDE_PATHS=""
for candidate in /usr/local/include /opt/homebrew/include "${BREW_PREFIX:+${BREW_PREFIX}/include}"; do
	[[ -d "$candidate" ]] || continue
	case ":$INCLUDE_PATHS:" in
		*:"$candidate":*) ;;
		*) INCLUDE_PATHS="${INCLUDE_PATHS:+$INCLUDE_PATHS:}$candidate" ;;
	esac
done

LIB_PATHS=""
for candidate in /usr/local/lib /opt/homebrew/lib "${BREW_PREFIX:+${BREW_PREFIX}/lib}"; do
	[[ -d "$candidate" ]] || continue
	case ":$LIB_PATHS:" in
		*:"$candidate":*) ;;
		*) LIB_PATHS="${LIB_PATHS:+$LIB_PATHS:}$candidate" ;;
	esac
done

[[ -n "$INCLUDE_PATHS" ]] || error "*** dependency missing: Unable to locate include directory. Install dependencies via Homebrew (brew bundle) or update 'local.rave' with the correct include paths."
[[ -n "$LIB_PATHS" ]] || error "*** dependency missing: Unable to locate library directory. Install dependencies via Homebrew (brew bundle) or update 'local.rave' with the correct library paths."

# ===============================
# = Check required dependencies =
# ===============================

for dep in capnp ninja ragel multimarkdown pgrep pkill; do
	which -s "$dep" || error "*** dependency missing: ‘${dep}’."
done

if [[ -e local.rave ]]; then
	echo >&2 "Skipping writing ‘local.rave’: File already exists"
else
	while IFS= read -r dir; do
		[[ -z "$dir" ]] && continue
		echo >> local.rave "add FLAGS    \"-I${dir}\""
	done <<EOF
$(printf "%s" "$INCLUDE_PATHS" | tr ':' '\n')
EOF

	while IFS= read -r dir; do
		[[ -z "$dir" ]] && continue
		echo >> local.rave "add LN_FLAGS \"-L${dir}\""
	done <<EOF
$(printf "%s" "$LIB_PATHS" | tr ':' '\n')
EOF

	for hdr in boost/{crc,variant}.hpp capnp/{message,serialize-packed}.h sparsehash/dense_hash_map; do
		header_exists "$hdr" || error "*** dependency missing: ‘${hdr}’. Install dependency and/or update ‘local.rave’ with correct path. Searched: $(printf "%s" "$INCLUDE_PATHS" | tr ':' ' ')"
	done

	for lib in capnp kj; do
		library_exists "$lib" || error "*** dependency missing: ‘lib${lib}.*’. Install dependency and/or update ‘local.rave’ with correct path. Searched: $(printf "%s" "$LIB_PATHS" | tr ':' ' ')"
	done
fi

# ========================
# = Generate build files =
# ========================

if [[ -d "$builddir" ]];
	then bin/rave -crelease -tTextMate -b"$builddir"
	else bin/rave -crelease -tTextMate
fi
